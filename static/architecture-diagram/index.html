<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chuk Chat - Architecture Diagram</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { width: 100%; height: 100%; overflow: hidden; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  body { background: #09090b; color: #fafafa; }
  body.light { background: #fff; color: #18181b; }

  /* Toolbar */
  #toolbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    height: 40px; display: flex; align-items: center; gap: 8px; padding: 0 12px;
    background: #18181b; border-bottom: 1px solid #27272a;
  }
  body.light #toolbar { background: #f4f4f5; border-color: #d4d4d8; }
  #toolbar button {
    background: #27272a; color: #fafafa; border: 1px solid #3f3f46;
    padding: 4px 12px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px;
  }
  body.light #toolbar button { background: #e4e4e7; color: #18181b; border-color: #a1a1aa; }
  #toolbar button:hover { opacity: 0.8; }
  #toolbar .sep { flex: 1; }
  #toolbar .info { font-size: 11px; color: #71717a; }
  #toolbar a { color: #a1a1aa; text-decoration: none; font-size: 12px; }
  body.light #toolbar a { color: #71717a; }

  /* Canvas area */
  #canvas {
    position: absolute; top: 40px; left: 0; right: 0; bottom: 0;
    overflow: hidden; cursor: grab;
  }
  #canvas:active { cursor: grabbing; }
  #canvas svg { position: absolute; top: 0; left: 0; transform-origin: 0 0; }

  /* SVG styles */
  svg a { cursor: pointer; }
  svg a rect { transition: stroke-width 0.1s, fill 0.1s; }
  svg a:hover rect { stroke-width: 2.5 !important; }
  svg text { pointer-events: none; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

  /* Dark mode (default) */
  svg a rect { fill: #18181b; stroke: #a1a1aa; }
  svg a:hover rect { fill: #27272a; stroke: #e4e4e7; }
  svg .node-title { fill: #fafafa; }
  svg .node-sub { fill: #a1a1aa; }
  svg .group-bg { fill: #09090b; stroke: #3f3f46; }
  svg .group-label { fill: #71717a; }
  svg .edge { stroke: #52525b; }
  svg .edge-label { fill: #71717a; }

  /* Light mode */
  body.light svg a rect { fill: #fafafa; stroke: #71717a; }
  body.light svg a:hover rect { fill: #f4f4f5; stroke: #18181b; }
  body.light svg .node-title { fill: #18181b; }
  body.light svg .node-sub { fill: #71717a; }
  body.light svg .group-bg { fill: #fff; stroke: #d4d4d8; }
  body.light svg .group-label { fill: #a1a1aa; }
  body.light svg .edge { stroke: #a1a1aa; }
  body.light svg .edge-label { fill: #a1a1aa; }

  /* Minimap */
  #minimap {
    position: fixed; bottom: 12px; right: 12px; z-index: 100;
    width: 200px; height: 140px; border: 1px solid #3f3f46; border-radius: 6px;
    background: #18181b; overflow: hidden; opacity: 0.85;
  }
  body.light #minimap { background: #f4f4f5; border-color: #d4d4d8; }
  #minimap svg { width: 100%; height: 100%; }
  #minimap .viewport-rect { fill: none; stroke: #fafafa; stroke-width: 3; }
  body.light #minimap .viewport-rect { stroke: #18181b; }

  /* Fullscreen hides toolbar margin */
  :fullscreen #toolbar { display: none; }
  :fullscreen #canvas { top: 0; }
</style>
</head>
<body>
<div id="toolbar">
  <a href="/">Back to Docs</a>
  <span style="color:#3f3f46;margin:0 4px;">|</span>
  <button onclick="zoomIn()">+ Zoom</button>
  <button onclick="zoomOut()">- Zoom</button>
  <button onclick="resetView()">Reset</button>
  <button onclick="fitAll()">Fit</button>
  <button onclick="toggleFullscreen()">Fullscreen</button>
  <button onclick="toggleTheme()">Light/Dark</button>
  <span class="sep"></span>
  <span class="info" id="zoom-info">100%</span>
</div>
<div id="canvas">
<svg id="diagram" width="1460" height="1350" viewBox="0 0 1460 1350" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#52525b"/></marker>
  </defs>

  <!-- ===== COL 1: USER ENTRY (x=10) ===== -->
  <rect class="group-bg" x="10" y="10" width="260" height="340" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="140" y="32" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">USER ENTRY</text>

  <a href="/files/lib/pages/"><rect x="30" y="50" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="140" y="68" text-anchor="middle" font-size="12" font-weight="bold">Login Page</text><text class="node-sub" x="140" y="84" text-anchor="middle" font-size="9">Email + Password</text></a>
  <a href="/files/platform-specific/chat-ui/"><rect x="30" y="110" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="140" y="128" text-anchor="middle" font-size="12" font-weight="bold">Chat UI</text><text class="node-sub" x="140" y="144" text-anchor="middle" font-size="9">Messages, Input, Streaming</text></a>
  <a href="/files/platform-specific/sidebars/"><rect x="30" y="170" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="140" y="188" text-anchor="middle" font-size="12" font-weight="bold">Sidebar</text><text class="node-sub" x="140" y="204" text-anchor="middle" font-size="9">Chat List, Navigation</text></a>
  <a href="/files/lib/widgets/"><rect x="30" y="230" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="140" y="248" text-anchor="middle" font-size="12" font-weight="bold">Widgets</text><text class="node-sub" x="140" y="264" text-anchor="middle" font-size="9">Reusable UI Components</text></a>
  <a href="/files/platform-specific/root-wrappers/"><rect x="30" y="290" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="140" y="308" text-anchor="middle" font-size="12" font-weight="bold">Platform Wrappers</text><text class="node-sub" x="140" y="324" text-anchor="middle" font-size="9">Desktop / Mobile / Web</text></a>

  <!-- ===== COL 2: AUTH & SECURITY (x=300) ===== -->
  <rect class="group-bg" x="300" y="10" width="260" height="520" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="430" y="32" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">AUTH &amp; SECURITY</text>

  <a href="/services/auth/auth-service/"><rect x="320" y="50" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="68" text-anchor="middle" font-size="12" font-weight="bold">Auth Service</text><text class="node-sub" x="430" y="84" text-anchor="middle" font-size="9">signIn / signUp / signOut</text></a>
  <a href="/services/auth/supabase-service/"><rect x="320" y="110" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="128" text-anchor="middle" font-size="12" font-weight="bold">Supabase Service</text><text class="node-sub" x="430" y="144" text-anchor="middle" font-size="9">GoTrue Client, PKCE Flow</text></a>
  <a href="/services/auth/encryption-service/"><rect x="320" y="170" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="188" text-anchor="middle" font-size="12" font-weight="bold">Encryption Service</text><text class="node-sub" x="430" y="204" text-anchor="middle" font-size="9">AES-256-GCM + PBKDF2</text></a>
  <a href="/services/auth/password-services/"><rect x="320" y="230" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="248" text-anchor="middle" font-size="12" font-weight="bold">Password Services</text><text class="node-sub" x="430" y="264" text-anchor="middle" font-size="9">Revision Tracking, Key Rotation</text></a>
  <a href="/services/auth/session-tracking/"><rect x="320" y="290" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="308" text-anchor="middle" font-size="12" font-weight="bold">Session Tracking</text><text class="node-sub" x="430" y="324" text-anchor="middle" font-size="9">Multi-Device, Fingerprinting</text></a>
  <a href="/security/session-management/"><rect x="320" y="350" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="368" text-anchor="middle" font-size="12" font-weight="bold">Session Management</text><text class="node-sub" x="430" y="384" text-anchor="middle" font-size="9">Token Refresh, Expiry</text></a>
  <a href="/security/token-handling/"><rect x="320" y="410" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="428" text-anchor="middle" font-size="12" font-weight="bold">Token Handling</text><text class="node-sub" x="430" y="444" text-anchor="middle" font-size="9">Access + Refresh Tokens</text></a>
  <a href="/security/certificate-pinning/"><rect x="320" y="470" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="430" y="488" text-anchor="middle" font-size="12" font-weight="bold">Certificate Pinning</text><text class="node-sub" x="430" y="504" text-anchor="middle" font-size="9">Dio HTTPS Pinning</text></a>

  <!-- ===== COL 3: CHAT & STORAGE (x=590) ===== -->
  <rect class="group-bg" x="590" y="10" width="260" height="580" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="720" y="32" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">CHAT &amp; STORAGE</text>

  <a href="/services/chat/chat-storage-service/"><rect x="610" y="50" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="68" text-anchor="middle" font-size="12" font-weight="bold">Chat Storage Service</text><text class="node-sub" x="720" y="84" text-anchor="middle" font-size="9">Facade Pattern</text></a>
  <a href="/services/chat/storage-modules/"><rect x="610" y="110" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="128" text-anchor="middle" font-size="12" font-weight="bold">Storage Modules</text><text class="node-sub" x="720" y="144" text-anchor="middle" font-size="9">CRUD, State, Mutations, Sync</text></a>
  <a href="/services/chat/chat-sync-service/"><rect x="610" y="170" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="188" text-anchor="middle" font-size="12" font-weight="bold">Chat Sync Service</text><text class="node-sub" x="720" y="204" text-anchor="middle" font-size="9">5-Second Polling</text></a>
  <a href="/models/stored-chat/"><rect x="610" y="230" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="248" text-anchor="middle" font-size="12" font-weight="bold">StoredChat Model</text><text class="node-sub" x="720" y="264" text-anchor="middle" font-size="9">Lazy-loaded Messages</text></a>
  <a href="/models/chat-message/"><rect x="610" y="290" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="308" text-anchor="middle" font-size="12" font-weight="bold">ChatMessage Model</text><text class="node-sub" x="720" y="324" text-anchor="middle" font-size="9">role, text, images, reasoning</text></a>
  <a href="/models/attached-file/"><rect x="610" y="350" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="368" text-anchor="middle" font-size="12" font-weight="bold">AttachedFile Model</text><text class="node-sub" x="720" y="384" text-anchor="middle" font-size="9">PDF, Doc, Images</text></a>
  <a href="/services/projects/project-storage-service/"><rect x="610" y="410" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="428" text-anchor="middle" font-size="12" font-weight="bold">Project Storage</text><text class="node-sub" x="720" y="444" text-anchor="middle" font-size="9">Workspaces, System Prompts</text></a>
  <a href="/services/projects/project-message-service/"><rect x="610" y="470" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="488" text-anchor="middle" font-size="12" font-weight="bold">Project Messages</text><text class="node-sub" x="720" y="504" text-anchor="middle" font-size="9">Context Injection</text></a>
  <a href="/models/project-models/"><rect x="610" y="530" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="720" y="548" text-anchor="middle" font-size="12" font-weight="bold">Project Models</text><text class="node-sub" x="720" y="564" text-anchor="middle" font-size="9">Project, ProjectFile</text></a>

  <!-- ===== COL 4: STREAMING & API (x=880) ===== -->
  <rect class="group-bg" x="880" y="10" width="260" height="580" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="1010" y="32" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">STREAMING &amp; API</text>

  <a href="/services/streaming/streaming-manager/"><rect x="900" y="50" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="68" text-anchor="middle" font-size="12" font-weight="bold">Streaming Manager</text><text class="node-sub" x="1010" y="84" text-anchor="middle" font-size="9">Orchestrates Active Streams</text></a>
  <a href="/services/streaming/http-streaming/"><rect x="900" y="110" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="128" text-anchor="middle" font-size="12" font-weight="bold">HTTP SSE Streaming</text><text class="node-sub" x="1010" y="144" text-anchor="middle" font-size="9">Server-Sent Events</text></a>
  <a href="/services/streaming/websocket-streaming/"><rect x="900" y="170" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="188" text-anchor="middle" font-size="12" font-weight="bold">WebSocket Streaming</text><text class="node-sub" x="1010" y="204" text-anchor="middle" font-size="9">Bidirectional Channel</text></a>
  <a href="/services/streaming/foreground-service/"><rect x="900" y="230" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="248" text-anchor="middle" font-size="12" font-weight="bold">Foreground Service</text><text class="node-sub" x="1010" y="264" text-anchor="middle" font-size="9">Android Background Keep-Alive</text></a>
  <a href="/models/chat-stream-event/"><rect x="900" y="290" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="308" text-anchor="middle" font-size="12" font-weight="bold">ChatStreamEvent</text><text class="node-sub" x="1010" y="324" text-anchor="middle" font-size="9">Content, Reasoning, Done</text></a>
  <a href="/api/chat-endpoints/"><rect x="900" y="350" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="368" text-anchor="middle" font-size="12" font-weight="bold">Chat Endpoints</text><text class="node-sub" x="1010" y="384" text-anchor="middle" font-size="9">/v1/ai/chat (OpenRouter)</text></a>
  <a href="/api/audio-endpoints/"><rect x="900" y="410" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="428" text-anchor="middle" font-size="12" font-weight="bold">Audio Endpoints</text><text class="node-sub" x="1010" y="444" text-anchor="middle" font-size="9">Groq Whisper Transcription</text></a>
  <a href="/api/image-endpoints/"><rect x="900" y="470" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="488" text-anchor="middle" font-size="12" font-weight="bold">Image Endpoints</text><text class="node-sub" x="1010" y="504" text-anchor="middle" font-size="9">FLUX Image Generation</text></a>
  <a href="/api/tts-endpoint/"><rect x="900" y="530" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1010" y="548" text-anchor="middle" font-size="12" font-weight="bold">TTS Endpoint</text><text class="node-sub" x="1010" y="564" text-anchor="middle" font-size="9">Text-to-Speech</text></a>

  <!-- ===== COL 5: BACKEND (x=1170) ===== -->
  <rect class="group-bg" x="1170" y="10" width="260" height="580" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="1300" y="32" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">SUPABASE BACKEND</text>

  <a href="/database/tables/encrypted-chats/"><rect x="1190" y="50" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="68" text-anchor="middle" font-size="12" font-weight="bold">encrypted_chats</text><text class="node-sub" x="1300" y="84" text-anchor="middle" font-size="9">Encrypted Chat Payloads</text></a>
  <a href="/database/tables/user-sessions/"><rect x="1190" y="110" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="128" text-anchor="middle" font-size="12" font-weight="bold">user_sessions</text><text class="node-sub" x="1300" y="144" text-anchor="middle" font-size="9">Device Tracking</text></a>
  <a href="/database/tables/profiles/"><rect x="1190" y="170" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="188" text-anchor="middle" font-size="12" font-weight="bold">profiles</text><text class="node-sub" x="1300" y="204" text-anchor="middle" font-size="9">User Metadata</text></a>
  <a href="/database/tables/projects/"><rect x="1190" y="230" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="248" text-anchor="middle" font-size="12" font-weight="bold">projects</text><text class="node-sub" x="1300" y="264" text-anchor="middle" font-size="9">Workspace Definitions</text></a>
  <a href="/database/tables/project-relations/"><rect x="1190" y="290" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="308" text-anchor="middle" font-size="12" font-weight="bold">project_relations</text><text class="node-sub" x="1300" y="324" text-anchor="middle" font-size="9">Chat-Project Links</text></a>
  <a href="/database/tables/preferences/"><rect x="1190" y="350" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="368" text-anchor="middle" font-size="12" font-weight="bold">preferences</text><text class="node-sub" x="1300" y="384" text-anchor="middle" font-size="9">User Settings</text></a>
  <a href="/database/tables/theme-settings/"><rect x="1190" y="410" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="428" text-anchor="middle" font-size="12" font-weight="bold">theme_settings</text><text class="node-sub" x="1300" y="444" text-anchor="middle" font-size="9">Colors, Font, Dark Mode</text></a>
  <a href="/database/storage-buckets/"><rect x="1190" y="470" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="488" text-anchor="middle" font-size="12" font-weight="bold">Storage Buckets</text><text class="node-sub" x="1300" y="504" text-anchor="middle" font-size="9">encrypted-images, project-files</text></a>
  <a href="/database/row-level-security/"><rect x="1190" y="530" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="548" text-anchor="middle" font-size="12" font-weight="bold">Row-Level Security</text><text class="node-sub" x="1300" y="564" text-anchor="middle" font-size="9">Per-User Data Isolation</text></a>

  <!-- ===== BOTTOM LEFT: CONFIG, MEDIA, PREFERENCES ===== -->
  <rect class="group-bg" x="10" y="620" width="550" height="280" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="285" y="642" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">CONFIG, MEDIA &amp; PREFERENCES</text>
  <a href="/services/config/api-config-service/"><rect x="30" y="660" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="150" y="678" text-anchor="middle" font-size="12" font-weight="bold">API Config Service</text><text class="node-sub" x="150" y="694" text-anchor="middle" font-size="9">Base URLs, API Keys</text></a>
  <a href="/services/config/model-services/"><rect x="300" y="660" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="420" y="678" text-anchor="middle" font-size="12" font-weight="bold">Model Services</text><text class="node-sub" x="420" y="694" text-anchor="middle" font-size="9">Model List, Prefetch, Selection</text></a>
  <a href="/services/config/api-status-service/"><rect x="30" y="720" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="150" y="738" text-anchor="middle" font-size="12" font-weight="bold">API Status Service</text><text class="node-sub" x="150" y="754" text-anchor="middle" font-size="9">Health Checks</text></a>
  <a href="/services/config/network-status-service/"><rect x="300" y="720" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="420" y="738" text-anchor="middle" font-size="12" font-weight="bold">Network Status</text><text class="node-sub" x="420" y="754" text-anchor="middle" font-size="9">Online/Offline Detection</text></a>
  <a href="/services/media/image-storage-service/"><rect x="30" y="780" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="150" y="798" text-anchor="middle" font-size="12" font-weight="bold">Image Storage</text><text class="node-sub" x="150" y="814" text-anchor="middle" font-size="9">Encrypted Image Upload</text></a>
  <a href="/services/media/image-compression-service/"><rect x="300" y="780" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="420" y="798" text-anchor="middle" font-size="12" font-weight="bold">Image Compression</text><text class="node-sub" x="420" y="814" text-anchor="middle" font-size="9">Quality Reduction</text></a>
  <a href="/services/media/file-conversion-service/"><rect x="30" y="840" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="150" y="858" text-anchor="middle" font-size="12" font-weight="bold">File Conversion</text><text class="node-sub" x="150" y="874" text-anchor="middle" font-size="9">PDF/Doc Processing</text></a>
  <a href="/services/media/image-generation-service/"><rect x="300" y="840" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="420" y="858" text-anchor="middle" font-size="12" font-weight="bold">Image Generation</text><text class="node-sub" x="420" y="874" text-anchor="middle" font-size="9">FLUX / AI Image API</text></a>

  <!-- ===== BOTTOM MIDDLE: SECURITY & ARCHITECTURE ===== -->
  <rect class="group-bg" x="590" y="620" width="550" height="280" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="865" y="642" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">SECURITY &amp; ARCHITECTURE</text>
  <a href="/security/encryption/"><rect x="610" y="660" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="730" y="678" text-anchor="middle" font-size="12" font-weight="bold">Encryption</text><text class="node-sub" x="730" y="694" text-anchor="middle" font-size="9">AES-256-GCM, PBKDF2 600K iter</text></a>
  <a href="/security/threat-model/"><rect x="880" y="660" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1000" y="678" text-anchor="middle" font-size="12" font-weight="bold">Threat Model</text><text class="node-sub" x="1000" y="694" text-anchor="middle" font-size="9">STRIDE Analysis</text></a>
  <a href="/security/input-validation/"><rect x="610" y="720" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="730" y="738" text-anchor="middle" font-size="12" font-weight="bold">Input Validation</text><text class="node-sub" x="730" y="754" text-anchor="middle" font-size="9">Sanitization, Length Limits</text></a>
  <a href="/security/rate-limiting/"><rect x="880" y="720" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1000" y="738" text-anchor="middle" font-size="12" font-weight="bold">Rate Limiting</text><text class="node-sub" x="1000" y="754" text-anchor="middle" font-size="9">Request Throttling</text></a>
  <a href="/security/security-checklist/"><rect x="610" y="780" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="730" y="798" text-anchor="middle" font-size="12" font-weight="bold">Security Checklist</text><text class="node-sub" x="730" y="814" text-anchor="middle" font-size="9">Audit Compliance</text></a>
  <a href="/security/zdr-provider-filtering/"><rect x="880" y="780" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1000" y="798" text-anchor="middle" font-size="12" font-weight="bold">ZDR Provider Filtering</text><text class="node-sub" x="1000" y="814" text-anchor="middle" font-size="9">Zero Data Retention</text></a>
  <a href="/architecture/layered-architecture/"><rect x="610" y="840" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="730" y="858" text-anchor="middle" font-size="12" font-weight="bold">Layered Architecture</text><text class="node-sub" x="730" y="874" text-anchor="middle" font-size="9">UI &gt; Service &gt; Data</text></a>
  <a href="/architecture/design-patterns/"><rect x="880" y="840" width="240" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1000" y="858" text-anchor="middle" font-size="12" font-weight="bold">Design Patterns</text><text class="node-sub" x="1000" y="874" text-anchor="middle" font-size="9">Facade, Singleton, Observer</text></a>

  <!-- ===== BOTTOM RIGHT: PLATFORM & DEV ===== -->
  <rect class="group-bg" x="1170" y="620" width="260" height="280" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="1300" y="642" text-anchor="middle" font-size="11" font-weight="bold" letter-spacing="1">PLATFORM &amp; DEV</text>
  <a href="/architecture/platform-abstraction/"><rect x="1190" y="660" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="678" text-anchor="middle" font-size="12" font-weight="bold">Platform Abstraction</text><text class="node-sub" x="1300" y="694" text-anchor="middle" font-size="9">Desktop / Mobile / Web</text></a>
  <a href="/architecture/handler-pattern/"><rect x="1190" y="720" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="738" text-anchor="middle" font-size="12" font-weight="bold">Handler Pattern</text><text class="node-sub" x="1300" y="754" text-anchor="middle" font-size="9">Platform-Specific Logic</text></a>
  <a href="/architecture/state-management/"><rect x="1190" y="780" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="798" text-anchor="middle" font-size="12" font-weight="bold">State Management</text><text class="node-sub" x="1300" y="814" text-anchor="middle" font-size="9">ValueNotifier, Streams</text></a>
  <a href="/development/"><rect x="1190" y="840" width="220" height="44" rx="6" stroke-width="1.5"/><text class="node-title" x="1300" y="858" text-anchor="middle" font-size="12" font-weight="bold">Development Guide</text><text class="node-sub" x="1300" y="874" text-anchor="middle" font-size="9">Build, Test, Debug, Deploy</text></a>

  <!-- ===== DATA FLOWS ===== -->
  <rect class="group-bg" x="10" y="930" width="1420" height="400" rx="10" stroke-width="1.5"/>
  <text class="group-label" x="720" y="955" text-anchor="middle" font-size="12" font-weight="bold" letter-spacing="1">DATA FLOWS</text>

  <!-- Login Flow -->
  <text class="node-title" x="30" y="985" font-size="12" font-weight="bold">Login Flow</text>
  <rect x="30" y="995" width="120" height="30" rx="5" stroke-width="1" class="group-bg"/><text class="node-sub" x="90" y="1015" text-anchor="middle" font-size="10">User Input</text>
  <line x1="150" y1="1010" x2="175" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/auth-service/"><rect x="175" y="995" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="235" y="1015" text-anchor="middle" font-size="10">Auth Service</text></a>
  <line x1="295" y1="1010" x2="320" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/supabase-service/"><rect x="320" y="995" width="130" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="385" y="1015" text-anchor="middle" font-size="10">Supabase PKCE</text></a>
  <line x1="450" y1="1010" x2="475" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/security/session-management/"><rect x="475" y="995" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="535" y="1015" text-anchor="middle" font-size="10">Session Token</text></a>
  <line x1="595" y1="1010" x2="620" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/encryption-service/"><rect x="620" y="995" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="690" y="1015" text-anchor="middle" font-size="10">Key Derivation</text></a>
  <line x1="760" y1="1010" x2="785" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/session-tracking/"><rect x="785" y="995" width="150" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="860" y="1015" text-anchor="middle" font-size="10">Register Device</text></a>
  <line x1="935" y1="1010" x2="960" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/config/model-services/"><rect x="960" y="995" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="1030" y="1015" text-anchor="middle" font-size="10">Prefetch Models</text></a>
  <line x1="1100" y1="1010" x2="1125" y2="1010" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/chat/chat-sync-service/"><rect x="1125" y="995" width="130" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="1190" y="1015" text-anchor="middle" font-size="10">Start Sync</text></a>

  <!-- Send Message Flow -->
  <text class="node-title" x="30" y="1065" font-size="12" font-weight="bold">Send Message Flow</text>
  <rect x="30" y="1075" width="120" height="30" rx="5" stroke-width="1" class="group-bg"/><text class="node-sub" x="90" y="1095" text-anchor="middle" font-size="10">User Types</text>
  <line x1="150" y1="1090" x2="175" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/files/platform-specific/chat-ui/"><rect x="175" y="1075" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="235" y="1095" text-anchor="middle" font-size="10">Chat UI</text></a>
  <line x1="295" y1="1090" x2="320" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/encryption-service/"><rect x="320" y="1075" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="380" y="1095" text-anchor="middle" font-size="10">Encrypt</text></a>
  <line x1="440" y1="1090" x2="465" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/chat/chat-storage-service/"><rect x="465" y="1075" width="130" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="530" y="1095" text-anchor="middle" font-size="10">Save to DB</text></a>
  <line x1="595" y1="1090" x2="620" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/streaming/streaming-manager/"><rect x="620" y="1075" width="150" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="695" y="1095" text-anchor="middle" font-size="10">Stream Manager</text></a>
  <line x1="770" y1="1090" x2="795" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/api/chat-endpoints/"><rect x="795" y="1075" width="130" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="860" y="1095" text-anchor="middle" font-size="10">OpenRouter API</text></a>
  <line x1="925" y1="1090" x2="950" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/models/chat-stream-event/"><rect x="950" y="1075" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="1010" y="1095" text-anchor="middle" font-size="10">SSE Events</text></a>
  <line x1="1070" y1="1090" x2="1095" y2="1090" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/tables/encrypted-chats/"><rect x="1095" y="1075" width="150" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="1170" y="1095" text-anchor="middle" font-size="10">Store Encrypted</text></a>

  <!-- Encryption Flow -->
  <text class="node-title" x="30" y="1145" font-size="12" font-weight="bold">Encryption Flow</text>
  <rect x="30" y="1155" width="120" height="30" rx="5" stroke-width="1" class="group-bg"/><text class="node-sub" x="90" y="1175" text-anchor="middle" font-size="10">Password</text>
  <line x1="150" y1="1170" x2="175" y2="1170" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/security/encryption/"><rect x="175" y="1155" width="150" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="250" y="1175" text-anchor="middle" font-size="10">PBKDF2 (600K)</text></a>
  <line x1="325" y1="1170" x2="350" y2="1170" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/encryption-service/"><rect x="350" y="1155" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="420" y="1175" text-anchor="middle" font-size="10">Derived Key</text></a>
  <line x1="490" y1="1170" x2="515" y2="1170" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/security/encryption/"><rect x="515" y="1155" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="585" y="1175" text-anchor="middle" font-size="10">AES-256-GCM</text></a>
  <line x1="655" y1="1170" x2="680" y2="1170" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <rect x="680" y="1155" width="180" height="30" rx="5" stroke-width="1" class="group-bg"/><text class="node-sub" x="770" y="1175" text-anchor="middle" font-size="10">{nonce, ciphertext, mac}</text>
  <line x1="860" y1="1170" x2="885" y2="1170" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/tables/encrypted-chats/"><rect x="885" y="1155" width="160" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="965" y="1175" text-anchor="middle" font-size="10">encrypted_payload</text></a>

  <!-- Sync Flow -->
  <text class="node-title" x="30" y="1225" font-size="12" font-weight="bold">Multi-Device Sync</text>
  <a href="/services/chat/chat-sync-service/"><rect x="30" y="1235" width="130" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="95" y="1255" text-anchor="middle" font-size="10">Poll (5s)</text></a>
  <line x1="160" y1="1250" x2="185" y2="1250" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/sync-strategy/"><rect x="185" y="1235" width="160" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="265" y="1255" text-anchor="middle" font-size="10">Compare Timestamps</text></a>
  <line x1="345" y1="1250" x2="370" y2="1250" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/tables/encrypted-chats/"><rect x="370" y="1235" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="440" y="1255" text-anchor="middle" font-size="10">Fetch Changes</text></a>
  <line x1="510" y1="1250" x2="535" y2="1250" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/auth/encryption-service/"><rect x="535" y="1235" width="120" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="595" y="1255" text-anchor="middle" font-size="10">Decrypt</text></a>
  <line x1="655" y1="1250" x2="680" y2="1250" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/chat/storage-modules/"><rect x="680" y="1235" width="140" height="30" rx="5" stroke-width="1.5"/><text class="node-title" x="750" y="1255" text-anchor="middle" font-size="10">Merge State</text></a>
  <line x1="820" y1="1250" x2="845" y2="1250" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <rect x="845" y="1235" width="120" height="30" rx="5" stroke-width="1" class="group-bg"/><text class="node-sub" x="905" y="1255" text-anchor="middle" font-size="10">Update UI</text>

  <!-- Preferences Flow -->
  <text class="node-title" x="30" y="1305" font-size="12" font-weight="bold">Preferences</text>
  <a href="/services/preferences/user-preferences-service/"><rect x="30" y="1310" width="160" height="24" rx="5" stroke-width="1.5"/><text class="node-title" x="110" y="1327" text-anchor="middle" font-size="10">User Prefs</text></a>
  <line x1="190" y1="1322" x2="210" y2="1322" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/preferences/theme-settings-service/"><rect x="210" y="1310" width="160" height="24" rx="5" stroke-width="1.5"/><text class="node-title" x="290" y="1327" text-anchor="middle" font-size="10">Theme Settings</text></a>
  <line x1="370" y1="1322" x2="390" y2="1322" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/services/preferences/customization-preferences-service/"><rect x="390" y="1310" width="160" height="24" rx="5" stroke-width="1.5"/><text class="node-title" x="470" y="1327" text-anchor="middle" font-size="10">Customization</text></a>
  <line x1="550" y1="1322" x2="570" y2="1322" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/tables/preferences/"><rect x="570" y="1310" width="160" height="24" rx="5" stroke-width="1.5"/><text class="node-title" x="650" y="1327" text-anchor="middle" font-size="10">DB: preferences</text></a>
  <line x1="730" y1="1322" x2="750" y2="1322" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <a href="/database/tables/theme-settings/"><rect x="750" y="1310" width="160" height="24" rx="5" stroke-width="1.5"/><text class="node-title" x="830" y="1327" text-anchor="middle" font-size="10">DB: theme_settings</text></a>

  <!-- ===== HORIZONTAL FLOW ARROWS between columns ===== -->
  <line x1="250" y1="72" x2="318" y2="72" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <text class="edge-label" x="284" y="62" font-size="9" text-anchor="middle">credentials</text>
  <line x1="540" y1="72" x2="608" y2="72" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <text class="edge-label" x="574" y="62" font-size="9" text-anchor="middle">session</text>
  <line x1="830" y1="72" x2="898" y2="72" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <text class="edge-label" x="864" y="62" font-size="9" text-anchor="middle">message</text>
  <line x1="1120" y1="72" x2="1188" y2="72" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <text class="edge-label" x="1154" y="62" font-size="9" text-anchor="middle">encrypted</text>

  <!-- Vertical connectors within columns -->
  <line x1="430" y1="94" x2="430" y2="108" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="154" x2="430" y2="168" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="214" x2="430" y2="228" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="274" x2="430" y2="288" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="334" x2="430" y2="348" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="394" x2="430" y2="408" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="430" y1="454" x2="430" y2="468" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="94" x2="720" y2="108" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="154" x2="720" y2="168" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="214" x2="720" y2="228" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="274" x2="720" y2="288" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="334" x2="720" y2="348" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="394" x2="720" y2="408" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="454" x2="720" y2="468" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="720" y1="514" x2="720" y2="528" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="94" x2="1010" y2="108" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="154" x2="1010" y2="168" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="214" x2="1010" y2="228" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="274" x2="1010" y2="288" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="334" x2="1010" y2="348" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="394" x2="1010" y2="408" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="454" x2="1010" y2="468" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1010" y1="514" x2="1010" y2="528" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="94" x2="1300" y2="108" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="154" x2="1300" y2="168" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="214" x2="1300" y2="228" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="274" x2="1300" y2="288" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="334" x2="1300" y2="348" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="394" x2="1300" y2="408" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="454" x2="1300" y2="468" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
  <line x1="1300" y1="514" x2="1300" y2="528" class="edge" stroke-width="1.5" marker-end="url(#ah)"/>
</svg>
</div>

<div id="minimap"></div>

<script>
const canvas = document.getElementById('canvas');
const svg = document.getElementById('diagram');
let scale = 1, panX = 0, panY = 0;
let dragging = false, lastX, lastY;

function applyTransform() {
  svg.style.transform = `translate(${panX}px,${panY}px) scale(${scale})`;
  document.getElementById('zoom-info').textContent = Math.round(scale * 100) + '%';
  updateMinimap();
}

function zoomIn() { scale = Math.min(scale * 1.25, 5); applyTransform(); }
function zoomOut() { scale = Math.max(scale / 1.25, 0.15); applyTransform(); }
function resetView() { scale = 1; panX = 0; panY = 0; applyTransform(); }
function fitAll() {
  const cw = canvas.clientWidth, ch = canvas.clientHeight;
  const sw = 1460, sh = 1350;
  scale = Math.min(cw / sw, ch / sh) * 0.95;
  panX = (cw - sw * scale) / 2;
  panY = (ch - sh * scale) / 2;
  applyTransform();
}
function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}
function toggleTheme() { document.body.classList.toggle('light'); }

canvas.addEventListener('mousedown', e => { if (e.button === 0) { dragging = true; lastX = e.clientX; lastY = e.clientY; }});
window.addEventListener('mousemove', e => { if (dragging) { panX += e.clientX - lastX; panY += e.clientY - lastY; lastX = e.clientX; lastY = e.clientY; applyTransform(); }});
window.addEventListener('mouseup', () => { dragging = false; });

canvas.addEventListener('wheel', e => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const factor = e.deltaY < 0 ? 1.1 : 1/1.1;
  const ns = Math.max(0.15, Math.min(5, scale * factor));
  panX = mx - (mx - panX) * (ns / scale);
  panY = my - (my - panY) * (ns / scale);
  scale = ns;
  applyTransform();
}, { passive: false });

// Touch support
let lastDist = 0, lastTouchX, lastTouchY;
canvas.addEventListener('touchstart', e => {
  if (e.touches.length === 1) { dragging = true; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; }
  if (e.touches.length === 2) { lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
});
canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 1 && dragging) {
    panX += e.touches[0].clientX - lastTouchX; panY += e.touches[0].clientY - lastTouchY;
    lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; applyTransform();
  }
  if (e.touches.length === 2) {
    const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
    scale = Math.max(0.15, Math.min(5, scale * (d / lastDist))); lastDist = d; applyTransform();
  }
}, { passive: false });
canvas.addEventListener('touchend', () => { dragging = false; });

// Minimap
function updateMinimap() {
  const mm = document.getElementById('minimap');
  const cw = canvas.clientWidth, ch = canvas.clientHeight;
  const sw = 1460, sh = 1350;
  const mmW = 200, mmH = 140;
  const s = Math.min(mmW / sw, mmH / sh);
  const vx = (-panX / scale) * s, vy = (-panY / scale) * s;
  const vw = (cw / scale) * s, vh = (ch / scale) * s;
  mm.innerHTML = `<svg viewBox="0 0 ${mmW} ${mmH}"><rect width="${sw*s}" height="${sh*s}" fill="none" stroke="#3f3f46" stroke-width="0.5"/><rect class="viewport-rect" x="${vx}" y="${vy}" width="${vw}" height="${vh}" rx="2"/></svg>`;
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (e.key === '+' || e.key === '=') zoomIn();
  if (e.key === '-') zoomOut();
  if (e.key === '0') resetView();
  if (e.key === 'f') fitAll();
  if (e.key === 'F11') { e.preventDefault(); toggleFullscreen(); }
});

// Make all SVG links open in the parent page (escape iframe)
document.querySelectorAll('#diagram a').forEach(a => a.setAttribute('target', '_top'));

// Initial fit
window.addEventListener('load', fitAll);
window.addEventListener('resize', fitAll);
</script>
</body>
</html>
